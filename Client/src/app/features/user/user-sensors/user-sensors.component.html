<div class="card w-3/4 max-w-7xl mx-auto">
  <div class="card-header">
    <h2 class="text-2xl font-bold">{{ 'USER.SENSORS.TITLE' | translate }}</h2>
  </div>

  <div *ngIf="isLoading" class="flex justify-center my-4">
    <app-loading-spinner [ariaLabel]="'UTILS.LOADING' | translate" />
  </div>

  <div class="card-body" *ngIf="!isLoading || sensors.length > 0">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <div *ngFor="let sensor of sensors" class="p-card p-4 shadow-md rounded-lg">
        <div class="flex justify-between items-center mb-2">
          <span class="text-lg font-semibold">{{ sensor.name }}</span>
          <i [class]="getSensorIcon(sensor.type)" class="text-xl"></i>
        </div>
        <div class="flex items-center">
          <div class="text-3xl font-bold">{{ sensor.value | number: '1.1-1' }}</div>
          <div class="ml-2 text-gray-500">{{ sensor.unit }}</div>
        </div>
        <div class="mt-2 text-sm">
          <span class="text-gray-600">SN: {{ sensor.serialNumber }}</span>
        </div>
        <div class="mt-2 text-sm" [ngClass]="getSensorStatusClass(sensor.status)">
          Status: {{ sensor.status }}
        </div>
        <div class="mt-1 text-sm text-gray-600">Lokalizacja: {{ sensor.location }}</div>
        <div class="mt-1 text-sm text-gray-500">
          Ostatnia aktualizacja: {{ sensor.lastUpdate | date: 'dd.MM.yyyy HH:mm' }}
        </div>
        <div class="mt-3 flex justify-end">
          <app-button
            [icon]="'pi pi-pencil'"
            [severity]="'secondary'"
            class="mr-2"
            (click)="editSensor(sensor.id)"
            pTooltip="{{ 'USER.SENSORS.EDIT' | translate }}"
            tooltipPosition="top"
          />
          <app-button
            [icon]="'pi pi-trash'"
            [severity]="'danger'"
            (click)="deleteSensor(sensor.id)"
            pTooltip="{{ 'USER.SENSORS.DELETE' | translate }}"
            tooltipPosition="top"
          />
        </div>

        <div class="mt-2 border-t pt-2">
          <button type="button" (click)="toggleDetails(sensor.id)" class="text-sm text-blue-600">
            {{ showDetailsMap[sensor.id] ? 'Ukryj szczegóły' : 'Pokaż szczegóły' }}
          </button>

          <div *ngIf="showDetailsMap[sensor.id]" class="mt-3 text-sm">
            <div *ngIf="sensor.street || sensor.city" class="mb-2">
              <div class="font-semibold">Adres:</div>
              <div>{{ sensor.street }}</div>
              <div>{{ sensor.city }}, {{ sensor.postalCode }}</div>
            </div>

            <div *ngIf="sensor.latitude && sensor.longitude" class="mb-2">
              <div class="font-semibold">Współrzędne:</div>
              <div>
                {{ sensor.latitude | number: '1.6-6' }}°N,
                {{ sensor.longitude | number: '1.6-6' }}°E
              </div>
            </div>

            <div class="font-semibold mt-3">Odczyty:</div>
            <div class="grid grid-cols-2 gap-2">
              <div *ngIf="sensor.humidity" class="flex justify-between">
                <span>Wilgotność:</span>
                <span>{{ sensor.humidity }}%</span>
              </div>
              <div *ngIf="sensor.airPressure" class="flex justify-between">
                <span>Ciśnienie:</span>
                <span>{{ sensor.airPressure }} hPa</span>
              </div>
              <div *ngIf="sensor.pm1_0" class="flex justify-between">
                <span>PM 1.0:</span>
                <span>{{ sensor.pm1_0 }} μg/m³</span>
              </div>
              <div *ngIf="sensor.pm2_5" class="flex justify-between">
                <span>PM 2.5:</span>
                <span>{{ sensor.pm2_5 }} μg/m³</span>
              </div>
              <div *ngIf="sensor.pm10" class="flex justify-between">
                <span>PM 10:</span>
                <span>{{ sensor.pm10 }} μg/m³</span>
              </div>
              <div *ngIf="sensor.waterLevel" class="flex justify-between">
                <span>Poziom wody:</span>
                <span>{{ sensor.waterLevel }} mm</span>
              </div>
              <div *ngIf="sensor.precipitation" class="flex justify-between">
                <span>Opady:</span>
                <span>{{ sensor.precipitation }} mm</span>
              </div>
              <div *ngIf="sensor.uvRadiation" class="flex justify-between">
                <span>Indeks UV:</span>
                <span>{{ sensor.uvRadiation }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="p-card p-4 shadow-md rounded-lg border-dashed border-2 border-gray-300 flex flex-col items-center justify-center cursor-pointer"
        (click)="showAddSensorForm()"
        *ngIf="!showForm"
      >
        <i class="pi pi-plus-circle text-3xl text-gray-400 mb-2"></i>
        <span>{{ 'USER.SENSORS.ADD_NEW' | translate }}</span>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && sensors.length === 0" class="text-center my-8">
    <i class="pi pi-info-circle text-3xl text-gray-400 mb-4"></i>
    <p class="text-lg text-gray-600">{{ 'USER.SENSORS.NO_SENSORS' | translate }}</p>
    <app-button
      (onClick)="showAddSensorForm()"
      [label]="'USER.SENSORS.ADD_NEW' | translate"
      [icon]="'pi pi-plus'"
      class="mt-4"
    />
  </div>

  <div class="card p-4 mt-4 border border-gray-200 rounded-lg" *ngIf="showForm">
    <h3 class="text-xl font-bold mb-4">{{ 'USER.SENSORS.ADD_NEW_FORM' | translate }}</h3>

    <div class="mb-4 text-sm text-gray-600">
      {{ 'USER.SENSORS.FORM_DESCRIPTION' | translate }}
    </div>

    <form [formGroup]="userSensorsForm" class="grid grid-cols-1 gap-4">
      <div class="mb-3">
        <app-input
          [formControl]="controls.sensorNumber"
          formControlName="sensorNumber"
          [placeholder]="'USER.SENSORS.SERIAL_NUMBER' | translate"
          [errorMessage]="getErrorMessage(controls.sensorNumber)"
          [invalid]="controls.sensorNumber.invalid && controls.sensorNumber.touched"
        />
      </div>

      <div class="mb-3">
        <app-input
          [formControl]="controls.name"
          formControlName="name"
          [placeholder]="'USER.SENSORS.SENSOR_NAME' | translate"
          [errorMessage]="getErrorMessage(controls.name)"
          [invalid]="controls.name.invalid && controls.name.touched"
        />
      </div>

      <div class="mb-3">
        <app-input
          [formControl]="controls.street"
          formControlName="street"
          [placeholder]="'USER.SENSORS.STREET' | translate"
          [errorMessage]="getErrorMessage(controls.street)"
          [invalid]="controls.street.invalid && controls.street.touched"
        />
      </div>

      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <app-input
            [formControl]="controls.city"
            formControlName="city"
            [placeholder]="'USER.SENSORS.CITY' | translate"
            [errorMessage]="getErrorMessage(controls.city)"
            [invalid]="controls.city.invalid && controls.city.touched"
          />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <app-input
            [formControl]="controls.postalCode"
            formControlName="postalCode"
            [placeholder]="'USER.SENSORS.POSTAL_CODE' | translate"
            [errorMessage]="getErrorMessage(controls.postalCode)"
            [invalid]="controls.postalCode.invalid && controls.postalCode.touched"
            pTooltip="{{ 'USER.SENSORS.POSTAL_CODE_FORMAT' | translate }}"
            tooltipPosition="top"
          />
        </div>
      </div>

      <div class="flex justify-start mb-3">
        <app-button
          (onClick)="cancelAddSensor()"
          type="button"
          [label]="'UTILS.CANCEL' | translate"
          [icon]="'pi pi-times'"
          [severity]="'secondary'"
          class="mr-2"
        />
        <app-button
          (onClick)="addSensor()"
          type="submit"
          [label]="'USER.SENSORS.ADD' | translate"
          [icon]="'pi pi-plus'"
          [loading]="isLoading"
          [disabled]="userSensorsForm.invalid"
        />
      </div>
    </form>
  </div>
</div>
